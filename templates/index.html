<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Tutor</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Physics Tutor</h1>
            <p class="text-gray-600">Your personal AI-powered physics learning assistant</p>
        </header>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Question Input Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex space-x-4 mb-4">
                    <button id="textBtn" class="flex-1 py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                        <i class="fas fa-keyboard mr-2"></i>Text Question
                    </button>
                    <button id="imageBtn" class="flex-1 py-2 px-4 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                        <i class="fas fa-camera mr-2"></i>Image Question
                    </button>
                </div>

                <!-- Text Input -->
                <div id="textInput" class="mb-4">
                    <textarea id="questionText" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                              rows="4" placeholder="Type your physics question here..."></textarea>
                </div>

                <!-- Image Input -->
                <div id="imageInput" class="hidden mb-4">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="imageUpload" accept="image/*" class="hidden">
                        <label for="imageUpload" class="cursor-pointer">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">Click to upload an image of your equation</p>
                        </label>
                        <div id="imagePreview" class="mt-4 hidden">
                            <img id="previewImg" class="max-h-48 mx-auto" src="" alt="Preview">
                        </div>
                    </div>
                </div>

                <button id="submitBtn" class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                    <i class="fas fa-paper-plane mr-2"></i>Submit Question
                </button>
            </div>

            <!-- Response Section -->
            <div id="responseSection" class="bg-white rounded-lg shadow-md p-6 hidden">
                <h2 class="text-2xl font-semibold mb-4">Solution</h2>
                <div id="explanation" class="prose max-w-none mb-6"></div>
                
                <!-- Steps -->
                <div id="steps" class="space-y-4 mb-6"></div>

                <!-- Student Response -->
                <div id="studentResponse" class="mt-6">
                    <textarea id="responseInput" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                              rows="3" placeholder="Type your response here..."></textarea>
                    <button id="nextStepBtn" class="mt-2 py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                        <i class="fas fa-arrow-right mr-2"></i>Next Step
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toggle between text and image input
        const textBtn = document.getElementById('textBtn');
        const imageBtn = document.getElementById('imageBtn');
        const textInput = document.getElementById('textInput');
        const imageInput = document.getElementById('imageInput');

        textBtn.addEventListener('click', () => {
            textBtn.classList.add('bg-blue-500', 'text-white');
            textBtn.classList.remove('bg-gray-200', 'text-gray-700');
            imageBtn.classList.add('bg-gray-200', 'text-gray-700');
            imageBtn.classList.remove('bg-blue-500', 'text-white');
            textInput.classList.remove('hidden');
            imageInput.classList.add('hidden');
        });

        imageBtn.addEventListener('click', () => {
            imageBtn.classList.add('bg-blue-500', 'text-white');
            imageBtn.classList.remove('bg-gray-200', 'text-gray-700');
            textBtn.classList.add('bg-gray-200', 'text-gray-700');
            textBtn.classList.remove('bg-blue-500', 'text-white');
            imageInput.classList.remove('hidden');
            textInput.classList.add('hidden');
        });

        // Handle image upload and preview
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Handle question submission
        const submitBtn = document.getElementById('submitBtn');
        const responseSection = document.getElementById('responseSection');
        const explanation = document.getElementById('explanation');
        const steps = document.getElementById('steps');

        // Add Enter key support
        document.getElementById('questionText').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitBtn.click();
            }
        });

        submitBtn.addEventListener('click', async () => {
            const questionType = textInput.classList.contains('hidden') ? 'image' : 'text';
            let content;

            if (questionType === 'text') {
                content = document.getElementById('questionText').value;
                // Clear input after submission
                document.getElementById('questionText').value = '';
            } else {
                // Get the file from the input
                const file = imageUpload.files[0];
                if (!file) {
                    alert('Please select an image first');
                    return;
                }
                
                // Create a FileReader to read the image
                const reader = new FileReader();
                
                // Convert the file to base64
                content = await new Promise((resolve, reject) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsDataURL(file);
                });
            }

            try {
                const response = await fetch('/process_question', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: questionType,
                        content: content
                    })
                });

                const data = await response.json();
                displayResponse(data);
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your question.');
            }
        });

        // Handle next step
        const nextStepBtn = document.getElementById('nextStepBtn');
        const responseInput = document.getElementById('responseInput');

        // Add Enter key support for response input
        responseInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                nextStepBtn.click();
            }
        });

        nextStepBtn.addEventListener('click', async () => {
            // const question = document.getElementById('questionText').value;
            const response = responseInput.value;
            const currentStep = parseInt(steps.dataset.currentStep || 0);

            try {
                const data = await fetch('/next_step', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        // question: question,
                        current_step: currentStep,
                        response: response
                    })
                });

                const responseData = await data.json();
                // Clear response input after submission
                responseInput.value = '';
                displayResponse(responseData);
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your response.');
            }
        });

        function displayResponse(data) {
            responseSection.classList.remove('hidden');
            
            // Process the explanation text to convert **text** to headings
            let processedExplanation = data.explanation;
            processedExplanation = processedExplanation.replace(/\*\*(.*?)\*\*/g, '<h3 class="text-xl font-semibold mt-4 mb-2">$1</h3>');
            explanation.innerHTML = processedExplanation;
            
            // Update steps
            steps.innerHTML = '';
            data.next_steps.forEach((step, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = 'p-4 bg-gray-50 rounded-lg';
                // Process step text to convert **text** to bold
                let processedStep = step.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                stepElement.innerHTML = `<strong>Step ${index + 1}:</strong> ${processedStep}`;
                steps.appendChild(stepElement);
            });
            steps.dataset.currentStep = data.next_steps.length;

            // Render math equations
            MathJax.typeset();
        }
    </script>
</body>
</html> 